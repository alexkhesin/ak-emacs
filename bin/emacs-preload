#!/bin/bash
# Usage: preload-emacs <name> [<waitp>]
#
# Preloads the Emacs daemon instance called NAME.
# Does nothing if the instance is already running.  If WAITP
# is non-empty, the function waits until the server starts up and
# creates its socket; otherwise it returns immediately.

name="$1"
waitp="$2"
serverdir="/tmp/emacs$UID"

if [ "$(uname -s)" = "Darwin" ]; then
  emacs=/Applications/Emacs.app/Contents/MacOS/Emacs
elif [ -e /usr/local/bin/emacs ]; then
  emacs=/usr/local/bin/emacs
else
  emacs=/usr/bin/emacs
fi

if [ -z "$name" ]; then
    echo "Usage: preload_emacs <name> [<waitp>]" >&2
    exit 1
fi

if [ ! -e "$serverdir/$name" ]; then
     "$emacs" --eval "(setq server-name \"$name\")" --daemon
fi
if [ ! -z "$waitp" ]; then
    while [ ! -e "$serverdir/$name" ]; do sleep 0.1; done
fi
